cscope 16 C:\VS_Project\opensource\example\linux_example               0000019640
	@C:\VS_Project\opensource\example\linux_example\ae_epoll.cpp

31 
	~<sys/•Şl.h
>

33 
	#zm®loc
 
m®loc


	)

34 
	#z»®loc
 
»®loc


	)

35 
	#zä“
 
ä“


	)

37 
	s«ApiS‹
 {

38 
	m•fd
;

39 
•Şl_ev’t
 *
	mev’ts
;

40 } 
	t«ApiS‹
;

42 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

43 
«ApiS‹
 *
¡©e
 = («ApiS‹*)
	`zm®loc
((aeApiState));

45 ià(!
¡©e
)  -1;

46 
¡©e
->
ev’ts
 = (
•Şl_ev’t
*)
	`zm®loc
((•Şl_ev’t)*
ev’tLoİ
->
£tsize
);

47 ià(!
¡©e
->
ev’ts
) {

48 
	`zä“
(
¡©e
);

51 
¡©e
->
•fd
 = 
	`•Şl_ü—‹
(1024);

52 ià(
¡©e
->
•fd
 == -1) {

53 
	`zä“
(
¡©e
->
ev’ts
);

54 
	`zä“
(
¡©e
);

57 
ev’tLoİ
->
­id©a
 = 
¡©e
;

59 
	}
}

61 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

62 
«ApiS‹
 *
¡©e
 = («ApiS‹*)
ev’tLoİ
->
­id©a
;

64 
¡©e
->
ev’ts
 = (
•Şl_ev’t
*)
	`z»®loc
(¡©e->ev’ts, (•Şl_ev’t)*
£tsize
);

66 
	}
}

68 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

69 
«ApiS‹
 *
¡©e
 = («ApiS‹*)
ev’tLoİ
->
­id©a
;

71 
	`şo£
(
¡©e
->
•fd
);

72 
	`zä“
(
¡©e
->
ev’ts
);

73 
	`zä“
(
¡©e
);

74 
	}
}

76 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

77 
«ApiS‹
 *
¡©e
 = («ApiS‹*)
ev’tLoİ
->
­id©a
;

78 
•Şl_ev’t
 
“
 = {0};

81 
İ
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
 =ğ
AE_NONE
 ?

82 
EPOLL_CTL_ADD
 : 
EPOLL_CTL_MOD
;

84 
“
.
ev’ts
 = 0;

85 
mask
 |ğ
ev’tLoİ
->
ev’ts
[
fd
].mask;

86 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

87 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

88 
“
.
d©a
.
fd
 = fd;

89 ià(
	`•Şl_ùl
(
¡©e
->
•fd
,
İ
,
fd
,&
“
) == -1)  -1;

91 
	}
}

93 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
d–mask
) {

94 
«ApiS‹
 *
¡©e
 = («ApiS‹*)
ev’tLoİ
->
­id©a
;

95 
•Şl_ev’t
 
“
 = {0};

96 
mask
 = 
ev’tLoİ
->
ev’ts
[
fd
].mask & (~
d–mask
);

98 
“
.
ev’ts
 = 0;

99 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

100 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

101 
“
.
d©a
.
fd
 = fd;

102 ià(
mask
 !ğ
AE_NONE
) {

103 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_MOD
,
fd
,&
“
);

107 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_DEL
,
fd
,&
“
);

109 
	}
}

111 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

112 
«ApiS‹
 *
¡©e
 = («ApiS‹*)
ev’tLoİ
->
­id©a
;

113 
»tv®
, 
numev’ts
 = 0;

115 
»tv®
 = 
	`•Şl_wa™
(
¡©e
->
•fd
,¡©e->
ev’ts
,
ev’tLoİ
->
£tsize
,

116 
tvp
 ? (tvp->
tv_£c
*1000 +vp->
tv_u£c
/1000) : -1);

117 ià(
»tv®
 > 0) {

118 
j
;

120 
numev’ts
 = 
»tv®
;

121 
j
 = 0; j < 
numev’ts
; j++) {

122 
mask
 = 0;

123 
•Şl_ev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

125 ià(
e
->
ev’ts
 & 
EPOLLIN
è
mask
 |ğ
AE_READABLE
;

126 ià(
e
->
ev’ts
 & 
EPOLLOUT
è
mask
 |ğ
AE_WRITABLE
;

127 ià(
e
->
ev’ts
 & 
EPOLLERR
è
mask
 |ğ
AE_WRITABLE
;

128 ià(
e
->
ev’ts
 & 
EPOLLHUP
è
mask
 |ğ
AE_WRITABLE
;

129 
ev’tLoİ
->
aùed
[
j
].
fd
 = 
e
->
d©a
.fd;

130 
ev’tLoİ
->
aùed
[
j
].
mask
 = mask;

133  
numev’ts
;

134 
	}
}

136 *
	$«ApiName
() {

138 
	}
}

	@C:\VS_Project\opensource\example\linux_example\event.cpp

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<uni¡d.h
>

4 
	~<time.h
>

5 
	~"ev’t.h
"

6 
	~"«_•Şl.ıp
"

8 
	#TEST_DENUG
 0

	)

11 
ProûssFeEv’t
(
«Ev’tLoİ
* 
ev’tLoİ
);

12 
ProûssTimeEv’t
(
«Ev’tLoİ
* 
ev’tLoİ
);

14 
«Ev’tLoİ
* 
	$C»©eEv’tLoİ
(
£tsize
)

16 
«Ev’tLoİ
* 
ev’tLoİ
 = 
NULL
;

18 if((
ev’tLoİ
 = (
«Ev’tLoİ
*)
	`m®loc
((*ev’tLoİ))è=ğ
NULL
)

20 
”r
;

22 
ev’tLoİ
->
ev’ts
 = (
«FeEv’t
*)
	`m®loc
(×eFeEv’t)*
£tsize
);

23 
ev’tLoİ
->
aùed
 = (
«AùedEv’t
*)
	`m®loc
(×eAùedEv’t)*
£tsize
);

24 if((
ev’tLoİ
->
ev’ts
 =ğ
NULL
è|| (ev’tLoİ->
aùed
 == NULL))

26 
”r
;

28 
ev’tLoİ
->
maxfd
 = -1;

29 
ev’tLoİ
->
£tsize
 = setsize;

31 
i
 = 0; i < 
£tsize
; i++)

33 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

35 if(
	`«ApiC»©e
(
ev’tLoİ
) == -1)

37 
”r
;

40  
ev’tLoİ
;

42 
”r
:

43 if(
ev’tLoİ
)

45 
	`ä“
(
ev’tLoİ
->
ev’ts
);

46 
	`ä“
(
ev’tLoİ
);

48  
NULL
;

49 
	}
}

51 
	$C»©eFeEv’t
(
«Ev’tLoİ
* 
ev’tLoİ
, 
fd
, 
mask
, 
«FeProc
* 
´oc
, * 
ş›ÁD©a
)

53 if(
ev’tLoİ
 =ğ
NULL
)

55  
AE_ERR
;

58 if(
fd
 >ğ
ev’tLoİ
->
£tsize
)

60  
AE_ERR
;

63 if(
	`«ApiAddEv’t
(
ev’tLoİ
, 
fd
, 
mask
) == -1)

65  
AE_ERR
;

68 
«FeEv’t
* 
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

69 
ã
->
mask
 |= mask;

70 if(
mask
 & 
AE_READABLE
)

72 
ã
->
rfeProc
 = 
´oc
;

74 if(
mask
 & 
AE_WRITABLE
)

76 
ã
->
wfeProc
 = 
´oc
;

78 
ã
->
ş›ÁD©a
 = clientData;

79 if(
fd
 > 
ev’tLoİ
->
maxfd
)

81 
ev’tLoİ
->
maxfd
 = 
fd
;

84  
AE_OK
;

85 
	}
}

87 
	$D–‘eFeEv’t
(
«Ev’tLoİ
* 
ev’tLoİ
, 
fd
, 
mask
)

89 if(
fd
 > 
ev’tLoİ
->
£tsize
)

94 
«FeEv’t
* 
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

95 if(
ã
->
mask
 =ğ
AE_NONE
)

100 
	`«ApiD–Ev’t
(
ev’tLoİ
, 
fd
, 
mask
);

101 
ã
->
mask
 &= (~mask);

104 if((
ev’tLoİ
->
maxfd
 =ğ
fd
è&& (
ã
->
mask
 =ğ
AE_NONE
))

106 
Ãwmax
 = -1;

107 
Ãwmax
 = 
ev’tLoİ
->
maxfd
-1;‚ewmax >= 0;‚ewmax--)

109 if(
ev’tLoİ
->
ev’ts
[
Ãwmax
].
mask
 !ğ
AE_NONE
)

114 
ev’tLoİ
->
maxfd
 = 
Ãwmax
;

116 
	}
}

118 
	$ProûssEv’t
(
«Ev’tLoİ
* 
ev’tLoİ
)

120 
	`ProûssFeEv’t
(
ev’tLoİ
);

121 
	`ProûssTimeEv’t
(
ev’tLoİ
);

122 
	}
}

124 
	$ProûssFeEv’t
(
«Ev’tLoİ
* 
ev’tLoİ
)

126 
numev’ts
 = 0;

127 
timev®
 
tvp
;

129 
tvp
.
tv_£c
 = 
AE_WAIT_TIME
;

130 
tvp
.
tv_u£c
 = 0;

131 
numev’ts
 = 
	`«ApiPŞl
(
ev’tLoİ
, &
tvp
);

132 if(
numev’ts
 <= 0)

137 
i
 = 0; i < 
numev’ts
; i++)

139 
fd
 = 
ev’tLoİ
->
aùed
[
i
].fd;

140 
mask
 = 
ev’tLoİ
->
aùed
[
i
].mask;

141 
«FeEv’t
* 
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

144 if(
ã
->
mask
 && (mask & 
AE_READABLE
))

146 
ã
->
	`rfeProc
(
ev’tLoİ
, 
fd
, fe->
ş›ÁD©a
, 
mask
);

148 if(
ã
-
mask
 && (mask & 
AE_WRITABLE
))

150 
ã
->
	`wfeProc
(
ev’tLoİ
, 
fd
, fe->
ş›ÁD©a
, 
mask
);

153  
numev’ts
;

154 
	}
}

156 
	$ProûssTimeEv’t
(
«Ev’tLoİ
* 
ev’tLoİ
)

159 
	}
}

161 
	$MašLoİ
(
«Ev’tLoİ
* 
ev’tLoİ
)

165 
	`ProûssEv’t
(
ev’tLoİ
);

168 
	}
}

170 #ià
TEST_DENUG


171 
	$maš
()

173 
	`´štf
("hello world\n");

175 
«Ev’tLoİ
* 
ev’tLoİ
 = 
	`C»©eEv’tLoİ
(
MAX_EVENT_NUM
);

176 if(
ev’tLoİ
 =ğ
NULL
)

180 
	`MašLoİ
(
ev’tLoİ
);

183 
	}
}

	@C:\VS_Project\opensource\example\linux_example\event.h

1 #iâdeà
__EVENT_H__


2 
	#__EVENT_H__


	)

5 
	#AE_WAIT_TIME
 2

	)

6 
	#AE_BUF_SIZE
 1024

	)

7 
	#MAX_EVENT_NUM
 (1024*10)

	)

9 
	#AE_OK
 0

	)

10 
	#AE_ERR
 -1

	)

12 
	#AE_NONE
 0

	)

13 
	#AE_READABLE
 1

	)

14 
	#AE_WRITABLE
 2

	)

16 
	#AE_FILE_EVENTS
 1

	)

17 
	#AE_TIME_EVENTS
 2

	)

18 
	#AE_ALL_EVENTS
 (
AE_FILE_EVENTS
|
AE_TIME_EVENTS
)

	)

19 
	#AE_DONT_WAIT
 4

	)

22 
	#AE_NOTUSED
(
V
è((èV)

	)

25 
	g«Ev’tLoİ
;

28 
	t«FeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tfd
, *
	tş›ÁD©a
, 
	tmask
);

31 
	s«FeEv’t
 {

32 
	mmask
;

33 
«FeProc
 *
	mrfeProc
;

34 
«FeProc
 *
	mwfeProc
;

35 *
	mş›ÁD©a
;

36 } 
	t«FeEv’t
;

39 
	s«AùedEv’t
 {

40 
	mfd
;

41 
	mmask
;

42 } 
	t«AùedEv’t
;

45 
	s«Ev’tLoİ
 {

46 
	mmaxfd
;

47 
	m£tsize
;

48 
«FeEv’t
 *
	mev’ts
;

49 
«AùedEv’t
 *
	maùed
;

51 *
	m­id©a
;

52 } 
	t«Ev’tLoİ
;

54 
«Ev’tLoİ
* 
C»©eEv’tLoİ
(
£tsize
);

55 
C»©eFeEv’t
(
«Ev’tLoİ
* 
ev’tLoİ
, 
fd
, 
mask
, 
«FeProc
* 
´oc
, * 
ş›ÁD©a
);

56 
D–‘eFeEv’t
(
«Ev’tLoİ
* 
ev’tLoİ
, 
fd
, 
mask
);

57 
ProûssEv’t
(
«Ev’tLoİ
* 
ev’tLoİ
);

58 
MašLoİ
(
«Ev’tLoİ
* 
ev’tLoİ
);

	@C:\VS_Project\opensource\example\linux_example\global.cpp

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~"glob®.h
"

5 
	#TEST_DEBUG
 0

	)

8 
CGlob®Cfg
* 
	gCGlob®Cfg
::
m_pIn¡ªû
 = 
NULL
;

11 
CGlob®Cfg
* 
	gCGlob®Cfg
::
	$In¡ªû
()

13 if(
NULL
 =ğ
m_pIn¡ªû
)

15 
m_pIn¡ªû
 = 
Ãw
 
CGlob®Cfg
;

17  
m_pIn¡ªû
;

18 
	}
}

20 
	gCGlob®Cfg
::
	$CGlob®Cfg
()

22 
m_ho¡
 = "";

23 
m_pÜt
 = 0;

24 
	}
}

26 
	gCGlob®Cfg
::~
	$CGlob®Cfg
()

29 
	}
}

31 
CGlob®Cfg
::
	$LßdCfg
(cÚ¡ * 
ho¡
, 
pÜt
)

33 
m_ho¡
 = 
ho¡
;

34 
m_pÜt
 = 
pÜt
;

35 
	}
}

37 #ià
TEST_DEBUG


38 
	$maš
()

40 
CGlob®Cfg
::
	`In¡ªû
()->
	`LßdCfg
("192.168.1.42", 8888);

41 
	`´štf
("[%s]…Üt[%d]\n", 
CGlob®Cfg
::
	`In¡ªû
()->
m_ho¡
.
	`c_¡r
(), CGlob®Cfg::In¡ªû()->
m_pÜt
);

44 
	}
}

	@C:\VS_Project\opensource\example\linux_example\global.h

1 #iâdeà
__GLOBAL_H__


2 
	#__GLOBAL_H__


	)

4 
	~<¡ršg
>

5 
	~"ev’t.h
"

6 
	~"hªdË.h
"

8 
usšg
 
Çme¥aû
 
	g¡d
;

11 şas 
	cCGlob®Cfg
 {

12 
	mpublic
:

13 
CGlob®Cfg
* 
In¡ªû
();

14 
LßdCfg
(cÚ¡ * 
ho¡
, 
pÜt
);

15 
	mpublic
:

16 
¡ršg
 
m_ho¡
;

17 
	mm_pÜt
;

20 
	mm_fd
;

21 
«Ev’tLoİ
* 
	mm_pEv’tLoİ
;

24 
Cl›ÁM­
 
	mm_ş›ÁM­
;

25 
	m´iv©e
:

26 
CGlob®Cfg
();

27 ~
CGlob®Cfg
();

28 
CGlob®Cfg
(const CGlobalCfg&);

29 
	mCGlob®Cfg
& 
	mİ”©Ü
=(cÚ¡ 
CGlob®Cfg
&);

30 
	m´iv©e
:

31 
CGlob®Cfg
* 
m_pIn¡ªû
;

	@C:\VS_Project\opensource\example\linux_example\handle.cpp

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<fú.h
>

5 
	~<uni¡d.h
>

6 
	~<sys/sock‘.h
>

7 
	~<¬·/š‘.h
>

8 
	~<”ºo.h
>

9 
	~"glob®.h
"

10 
	~"ev’t.h
"

11 
	~"hªdË.h
"

13 
	gCCl›Á
::
	$CCl›Á
(cÚ¡ * 
Çme
, 
fd
)

15 
m_cfd
 = 
fd
;

16 
m_Çme
 = 
Çme
;

17 
	`mem£t
(
m_qu”ybuf
, 0x0, (m_querybuf));

18 
m_Ä—d
 = 0;

19 
	}
}

21 
	gCCl›Á
::~
	$CCl›Á
()

24 
	}
}

26 
CCl›Á
::
	$OnCÚÃùed
()

28 
	`´štf
("ş›Á fd[%d] cÚÃùed sucûss\n", 
m_cfd
);

29 
	}
}

31 
	gCCl›Á
::
	$ProûssQu”y
()

34 
m_Ä—d
 = 
	`»ad
(
m_cfd
, 
m_qu”ybuf
, (m_querybuf));

35 if(
m_Ä—d
 == -1)

37 if(
”ºo
 !ğ
EAGAIN
)

39 
	`De¡royCl›Á
(
m_cfd
);

41 
	`´štf
("”ºo[%d]: %s\n", 
”ºo
, 
	`¡»¼Ü
(errno));

44 if(
m_Ä—d
 == 0)

46 
	`De¡royCl›Á
(
m_cfd
);

49 
m_qu”ybuf
[
m_Ä—d
] = '\0';

50 
	`´štf
("»cv:%s", 
m_qu”ybuf
);

53 
buf
[
AE_BUF_SIZE
];

54 
	`¢´štf
(
buf
, (buf), "h–lØunixime[%d]\n", 
	`time
(
NULL
));

55 
	`S’dToCl›Á
(
buf
, 
	`¡¾’
(buf));

58 
	}
}

60 
	gCCl›Á
::
	$S’dToCl›Á
(cÚ¡ * 
buf
, 
Ën
)

62 
ssize_t
 
nwr™‹n
 = 0;

64 if(
Ën
 > (
m_»¶ybuf
))

66 
Ën
 = (
m_»¶ybuf
) - 1;

68 
	`memıy
(
m_»¶ybuf
, 
buf
, 
Ën
);

69 
m_»¶yËn
 = 
Ën
;

71 if(
m_»¶yËn
 > 0)

73 
nwr™‹n
 = 
	`wr™e
(
m_cfd
, 
m_»¶ybuf
, 
m_»¶yËn
);

74 if(
nwr™‹n
 == -1)

76 if(
”ºo
 !ğ
EAGAIN
)

78 
	`De¡royCl›Á
(
m_cfd
);

79 
	`´štf
("E¼Ü wr™šgØş›Á fd[%d]: %s", 
m_cfd
, 
	`¡»¼Ü
(
”ºo
));

83 
	}
}

85 
	$In™S”v”
(
pÜt
)

87 
s
 = -1;

88 
yes
 = 1;

89 
æags
 = 0;

90 
domaš
 = 0;

91 
sockaddr_š
 
§
;

93 
	`bz”o
(&
§
, (sa));

94 
§
.
sš_çmy
 = 
AF_INET
;

95 
§
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

97 if((
s
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 0)) == -1)

99 
	`şo£
(
s
);

102 if(
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
yes
, (yes)) == -1)

104 
	`şo£
(
s
);

107 if(
	`bšd
(
s
, (
sockaddr
*)&
§
, (sa)) == -1)

109 
	`şo£
(
s
);

112 if(
	`li¡’
(
s
, 0) == -1)

114 
	`şo£
(
s
);

117 if((
æags
 = 
	`fú
(
s
, 
F_GETFL
)) == -1)

119 
	`şo£
(
s
);

122 
æags
 |ğ
O_NONBLOCK
;

123 if(
	`fú
(
s
, 
F_SETFL
, 
æags
) == -1)

125 
	`şo£
(
s
);

129  
s
;

130 
	}
}

132 
	$C»©eCl›Á
(
cfd
)

134 if(
cfd
 < 0)

139 if(
	`C»©eFeEv’t
(
CGlob®Cfg
::
	`In¡ªû
()->
m_pEv’tLoİ
,

140 
cfd
, 
AE_READABLE
, 
HªdËQu”y
, 
NULL
) == -1)

142 
	`´štf
("% ”r\n", 
__FUNCTION__
);

143 
	`şo£
(
cfd
);

148 if(
CGlob®Cfg
::
	`In¡ªû
()->
m_ş›ÁM­
.
	`fšd
(
cfd
)

149 !ğ
CGlob®Cfg
::
	`In¡ªû
()->
m_ş›ÁM­
.
	`’d
())

151 
	`De¡royCl›Á
(
cfd
);

152 
	`´štf
("ş›Á fd[%d]‡Ì—dyƒxix¡! d–‘™\n", 
cfd
);

154 
CCl›Á
* 
ş›Á
 = 
Ãw
 
	`CCl›Á
("", 
cfd
);

155 
CGlob®Cfg
::
	`In¡ªû
()->
m_ş›ÁM­
[
cfd
] = 
ş›Á
;

158 
ş›Á
->
	`OnCÚÃùed
();

160 
	}
}

163 
	$De¡royCl›Á
(
fd
)

165 
Cl›ÁM­
::
™”©Ü
 
™
 = 
CGlob®Cfg
::
	`In¡ªû
()->
m_ş›ÁM­
.
	`fšd
(
fd
);

166 if(
™
 !ğ
CGlob®Cfg
::
	`In¡ªû
()->
m_ş›ÁM­
.
	`’d
())

168 
	`D–‘eFeEv’t
(
CGlob®Cfg
::
	`In¡ªû
()->
m_pEv’tLoİ
, 
fd
, 
AE_READABLE
);

169 
	`D–‘eFeEv’t
(
CGlob®Cfg
::
	`In¡ªû
()->
m_pEv’tLoİ
, 
fd
, 
AE_WRITABLE
);

170 
	`şo£
(
fd
);

172 
	`d–‘e
(
™
->
£cÚd
);

173 
CGlob®Cfg
::
	`In¡ªû
()->
m_ş›ÁM­
.
	`”a£
(
™
++);

174 
	`´štf
("ş›Á fd[%d], clo£d sucûss\n", 
fd
);

176 
	}
}

178 
	$HªdËQu”y
(
«Ev’tLoİ
* 
ev’tLoİ
, 
fd
, * 
ş›ÁD©a
, 
mask
)

180 
	`AE_NOTUSED
(
ev’tLoİ
);

181 
	`AE_NOTUSED
(
ş›ÁD©a
);

182 
	`AE_NOTUSED
(
mask
);

184 
Cl›ÁM­
::
™”©Ü
 
™
 = 
CGlob®Cfg
::
	`In¡ªû
()->
m_ş›ÁM­
.
	`fšd
(
fd
);

185 if(
™
 !ğ
CGlob®Cfg
::
	`In¡ªû
()->
m_ş›ÁM­
.
	`’d
())

187 (
™
->
£cÚd
)->
	`ProûssQu”y
();

191 
	}
}

193 
	$HªdËAcû±
(
«Ev’tLoİ
* 
ev’tLoİ
, 
fd
, * 
ş›ÁD©a
, 
mask
)

195 
cfd
 = 0;

196 
sockaddr_š
 
§
;

197 
sockËn_t
 
§Ën
 = 0;

199 
	`AE_NOTUSED
(
ev’tLoİ
);

200 
	`AE_NOTUSED
(
ş›ÁD©a
);

201 
	`AE_NOTUSED
(
mask
);

205 
cfd
 = 
	`acû±
(
fd
, (
sockaddr
*)&
§
, &
§Ën
);

206 if(
cfd
 == -1)

208 if(
”ºo
 =ğ
EINTR
)

217 
	`C»©eCl›Á
(
cfd
);

218  
cfd
;

220 
	}
}

	@C:\VS_Project\opensource\example\linux_example\handle.h

1 #iâdeà
__HANDLE_H__


2 
	#__HANDLE_H__


	)

4 
	~<¡ršg
>

5 
	~<m­
>

6 
	~"ev’t.h
"

8 
usšg
 
Çme¥aû
 
	g¡d
;

10 
şass
 
	gCCl›Á
;

12 
	g¡d
::
	tm­
<, 
	tCCl›Á
*> 
	tCl›ÁM­
;

14 şas 
	cCCl›Á


16 
	mpublic
:

17 
CCl›Á
(cÚ¡ * 
Çme
, 
fd
);

18 ~
CCl›Á
();

19 
CCl›Á
(const CClient&);

20 
	mCCl›Á
& 
	mİ”©Ü
=(cÚ¡ 
CCl›Á
&);

21 
	mpublic
:

22 
OnCÚÃùed
();

23 
ProûssQu”y
();

24 
S’dToCl›Á
(cÚ¡ * 
buf
, 
Ën
);

25 
	m´iv©e
:

26 
m_cfd
;

27 
¡ršg
 
	mm_Çme
;

30 
	mm_qu”ybuf
[
AE_BUF_SIZE
];

31 
	mm_Ä—d
;

34 
	mm_»¶ybuf
[
AE_BUF_SIZE
];

35 
	mm_»¶yËn
;

39 
In™S”v”
(
pÜt
);

40 
C»©eCl›Á
(
cfd
);

41 
De¡royCl›Á
(
fd
);

42 
HªdËQu”y
(
«Ev’tLoİ
* 
ev’tLoİ
, 
fd
, * 
ş›ÁD©a
, 
mask
);

43 
HªdËAcû±
(
«Ev’tLoİ
* 
ev’tLoİ
, 
fd
, * 
ş›ÁD©a
, 
mask
);

	@C:\VS_Project\opensource\example\linux_example\server.cpp

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~"glob®.h
"

4 
	~"ev’t.h
"

5 
	~"hªdË.h
"

8 
	$maš
()

10 
CGlob®Cfg
::
	`In¡ªû
()->
	`LßdCfg
("127.0.0.1", 9600);

11 
CGlob®Cfg
::
	`In¡ªû
()->
m_fd
 = 
	`In™S”v”
(CGlob®Cfg::In¡ªû()->
m_pÜt
);

12 
CGlob®Cfg
::
	`In¡ªû
()->
m_pEv’tLoİ
 = 
	`C»©eEv’tLoİ
(
MAX_EVENT_NUM
);

13 if((
CGlob®Cfg
::
	`In¡ªû
()->
m_fd
 =ğ-1è|| (CGlob®Cfg::In¡ªû()->
m_pEv’tLoİ
 =ğ
NULL
))

17 
	`C»©eFeEv’t
(
CGlob®Cfg
::
	`In¡ªû
()->
m_pEv’tLoİ
, CGlob®Cfg::In¡ªû()->
m_fd
,

18 
AE_READABLE
, 
HªdËAcû±
, 
NULL
);

19 
	`MašLoİ
(
CGlob®Cfg
::
	`In¡ªû
()->
m_pEv’tLoİ
);

22 
	}
}

	@ae_epoll.cpp

31 
	~<sys/•Şl.h
>

33 
	#zm®loc
 
m®loc


	)

34 
	#z»®loc
 
»®loc


	)

35 
	#zä“
 
ä“


	)

37 
	s«ApiS‹
 {

38 
	m•fd
;

39 
•Şl_ev’t
 *
	mev’ts
;

40 } 
	t«ApiS‹
;

42 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

43 
«ApiS‹
 *
¡©e
 = («ApiS‹*)
	`zm®loc
((aeApiState));

45 ià(!
¡©e
)  -1;

46 
¡©e
->
ev’ts
 = (
•Şl_ev’t
*)
	`zm®loc
((•Şl_ev’t)*
ev’tLoİ
->
£tsize
);

47 ià(!
¡©e
->
ev’ts
) {

48 
	`zä“
(
¡©e
);

51 
¡©e
->
•fd
 = 
	`•Şl_ü—‹
(1024);

52 ià(
¡©e
->
•fd
 == -1) {

53 
	`zä“
(
¡©e
->
ev’ts
);

54 
	`zä“
(
¡©e
);

57 
ev’tLoİ
->
­id©a
 = 
¡©e
;

59 
	}
}

61 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

62 
«ApiS‹
 *
¡©e
 = («ApiS‹*)
ev’tLoİ
->
­id©a
;

64 
¡©e
->
ev’ts
 = (
•Şl_ev’t
*)
	`z»®loc
(¡©e->ev’ts, (•Şl_ev’t)*
£tsize
);

66 
	}
}

68 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

69 
«ApiS‹
 *
¡©e
 = («ApiS‹*)
ev’tLoİ
->
­id©a
;

71 
	`şo£
(
¡©e
->
•fd
);

72 
	`zä“
(
¡©e
->
ev’ts
);

73 
	`zä“
(
¡©e
);

74 
	}
}

76 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

77 
«ApiS‹
 *
¡©e
 = («ApiS‹*)
ev’tLoİ
->
­id©a
;

78 
•Şl_ev’t
 
“
 = {0};

81 
İ
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
 =ğ
AE_NONE
 ?

82 
EPOLL_CTL_ADD
 : 
EPOLL_CTL_MOD
;

84 
“
.
ev’ts
 = 0;

85 
mask
 |ğ
ev’tLoİ
->
ev’ts
[
fd
].mask;

86 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

87 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

88 
“
.
d©a
.
fd
 = fd;

89 ià(
	`•Şl_ùl
(
¡©e
->
•fd
,
İ
,
fd
,&
“
) == -1)  -1;

91 
	}
}

93 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
d–mask
) {

94 
«ApiS‹
 *
¡©e
 = («ApiS‹*)
ev’tLoİ
->
­id©a
;

95 
•Şl_ev’t
 
“
 = {0};

96 
mask
 = 
ev’tLoİ
->
ev’ts
[
fd
].mask & (~
d–mask
);

98 
“
.
ev’ts
 = 0;

99 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

100 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

101 
“
.
d©a
.
fd
 = fd;

102 ià(
mask
 !ğ
AE_NONE
) {

103 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_MOD
,
fd
,&
“
);

107 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_DEL
,
fd
,&
“
);

109 
	}
}

111 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

112 
«ApiS‹
 *
¡©e
 = («ApiS‹*)
ev’tLoİ
->
­id©a
;

113 
»tv®
, 
numev’ts
 = 0;

115 
»tv®
 = 
	`•Şl_wa™
(
¡©e
->
•fd
,¡©e->
ev’ts
,
ev’tLoİ
->
£tsize
,

116 
tvp
 ? (tvp->
tv_£c
*1000 +vp->
tv_u£c
/1000) : -1);

117 ià(
»tv®
 > 0) {

118 
j
;

120 
numev’ts
 = 
»tv®
;

121 
j
 = 0; j < 
numev’ts
; j++) {

122 
mask
 = 0;

123 
•Şl_ev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

125 ià(
e
->
ev’ts
 & 
EPOLLIN
è
mask
 |ğ
AE_READABLE
;

126 ià(
e
->
ev’ts
 & 
EPOLLOUT
è
mask
 |ğ
AE_WRITABLE
;

127 ià(
e
->
ev’ts
 & 
EPOLLERR
è
mask
 |ğ
AE_WRITABLE
;

128 ià(
e
->
ev’ts
 & 
EPOLLHUP
è
mask
 |ğ
AE_WRITABLE
;

129 
ev’tLoİ
->
aùed
[
j
].
fd
 = 
e
->
d©a
.fd;

130 
ev’tLoİ
->
aùed
[
j
].
mask
 = mask;

133  
numev’ts
;

134 
	}
}

136 *
	$«ApiName
() {

138 
	}
}

	@event.h

1 #iâdeà
__EVENT_H__


2 
	#__EVENT_H__


	)

5 
	#AE_WAIT_TIME
 2

	)

6 
	#AE_BUF_SIZE
 1024

	)

7 
	#MAX_EVENT_NUM
 (1024*10)

	)

9 
	#AE_OK
 0

	)

10 
	#AE_ERR
 -1

	)

12 
	#AE_NONE
 0

	)

13 
	#AE_READABLE
 1

	)

14 
	#AE_WRITABLE
 2

	)

16 
	#AE_FILE_EVENTS
 1

	)

17 
	#AE_TIME_EVENTS
 2

	)

18 
	#AE_ALL_EVENTS
 (
AE_FILE_EVENTS
|
AE_TIME_EVENTS
)

	)

19 
	#AE_DONT_WAIT
 4

	)

22 
	#AE_NOTUSED
(
V
è((èV)

	)

25 
	g«Ev’tLoİ
;

28 
	t«FeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tfd
, *
	tş›ÁD©a
, 
	tmask
);

31 
	s«FeEv’t
 {

32 
	mmask
;

33 
«FeProc
 *
	mrfeProc
;

34 
«FeProc
 *
	mwfeProc
;

35 *
	mş›ÁD©a
;

36 } 
	t«FeEv’t
;

39 
	s«AùedEv’t
 {

40 
	mfd
;

41 
	mmask
;

42 } 
	t«AùedEv’t
;

45 
	s«Ev’tLoİ
 {

46 
	mmaxfd
;

47 
	m£tsize
;

48 
«FeEv’t
 *
	mev’ts
;

49 
«AùedEv’t
 *
	maùed
;

51 *
	m­id©a
;

52 } 
	t«Ev’tLoİ
;

54 
«Ev’tLoİ
* 
C»©eEv’tLoİ
(
£tsize
);

55 
C»©eFeEv’t
(
«Ev’tLoİ
* 
ev’tLoİ
, 
fd
, 
mask
, 
«FeProc
* 
´oc
, * 
ş›ÁD©a
);

56 
D–‘eFeEv’t
(
«Ev’tLoİ
* 
ev’tLoİ
, 
fd
, 
mask
);

57 
ProûssEv’t
(
«Ev’tLoİ
* 
ev’tLoİ
);

58 
MašLoİ
(
«Ev’tLoİ
* 
ev’tLoİ
);

	@global.h

1 #iâdeà
__GLOBAL_H__


2 
	#__GLOBAL_H__


	)

4 
	~<¡ršg
>

5 
	~"ev’t.h
"

6 
	~"hªdË.h
"

8 
usšg
 
Çme¥aû
 
	g¡d
;

11 şas 
	cCGlob®Cfg
 {

12 
	mpublic
:

13 
CGlob®Cfg
* 
In¡ªû
();

14 
LßdCfg
(cÚ¡ * 
ho¡
, 
pÜt
);

15 
	mpublic
:

16 
¡ršg
 
m_ho¡
;

17 
	mm_pÜt
;

20 
	mm_fd
;

21 
«Ev’tLoİ
* 
	mm_pEv’tLoİ
;

24 
Cl›ÁM­
 
	mm_ş›ÁM­
;

25 
	m´iv©e
:

26 
CGlob®Cfg
();

27 ~
CGlob®Cfg
();

28 
CGlob®Cfg
(const CGlobalCfg&);

29 
	mCGlob®Cfg
& 
	mİ”©Ü
=(cÚ¡ 
CGlob®Cfg
&);

30 
	m´iv©e
:

31 
CGlob®Cfg
* 
m_pIn¡ªû
;

	@handle.h

1 #iâdeà
__HANDLE_H__


2 
	#__HANDLE_H__


	)

4 
	~<¡ršg
>

5 
	~<m­
>

6 
	~"ev’t.h
"

8 
usšg
 
Çme¥aû
 
	g¡d
;

10 
şass
 
	gCCl›Á
;

12 
	g¡d
::
	tm­
<, 
	tCCl›Á
*> 
	tCl›ÁM­
;

14 şas 
	cCCl›Á


16 
	mpublic
:

17 
CCl›Á
(cÚ¡ * 
Çme
, 
fd
);

18 ~
CCl›Á
();

19 
CCl›Á
(const CClient&);

20 
	mCCl›Á
& 
	mİ”©Ü
=(cÚ¡ 
CCl›Á
&);

21 
	mpublic
:

22 
OnCÚÃùed
();

23 
ProûssQu”y
();

24 
S’dToCl›Á
(cÚ¡ * 
buf
, 
Ën
);

25 
	m´iv©e
:

26 
m_cfd
;

27 
¡ršg
 
	mm_Çme
;

30 
	mm_qu”ybuf
[
AE_BUF_SIZE
];

31 
	mm_Ä—d
;

34 
	mm_»¶ybuf
[
AE_BUF_SIZE
];

35 
	mm_»¶yËn
;

39 
In™S”v”
(
pÜt
);

40 
C»©eCl›Á
(
cfd
);

41 
De¡royCl›Á
(
fd
);

42 
HªdËQu”y
(
«Ev’tLoİ
* 
ev’tLoİ
, 
fd
, * 
ş›ÁD©a
, 
mask
);

43 
HªdËAcû±
(
«Ev’tLoİ
* 
ev’tLoİ
, 
fd
, * 
ş›ÁD©a
, 
mask
);

	@
1
.
0
12
497
C:\VS_Project\opensource\example\linux_example\ae_epoll.cpp
C:\VS_Project\opensource\example\linux_example\event.cpp
C:\VS_Project\opensource\example\linux_example\event.h
C:\VS_Project\opensource\example\linux_example\global.cpp
C:\VS_Project\opensource\example\linux_example\global.h
C:\VS_Project\opensource\example\linux_example\handle.cpp
C:\VS_Project\opensource\example\linux_example\handle.h
C:\VS_Project\opensource\example\linux_example\server.cpp
ae_epoll.cpp
event.h
global.h
handle.h
